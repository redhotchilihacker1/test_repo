import xml.etree.ElementTree as ET
import pandas as pd
from bs4 import BeautifulSoup
import sys

# Kullanıcıdan dosya yolunu ve kaydedilecek dosya adını al
if len(sys.argv) != 3:
    print("Kullanım: python script.py <input.nessus> <output_filename>")
    sys.exit(1)

nessus_file = sys.argv[1]
output_filename = sys.argv[2]

# Nessus dosyasını yükle ve BeautifulSoup ile ayrıştır
with open(nessus_file, 'r', encoding='utf-8') as file:
    content = file.read()
    soup = BeautifulSoup(content, 'xml')  # XML olarak ayrıştır

# Verileri tutmak için listeler
data = []

# Risk Factor önceliklerini tanımla
risk_order = {
    "Critical": 1,
    "High": 2,
    "Medium": 3,
    "Low": 4,
    "None": 5  # "None" olanları en sona eklemek için
}

# Nessus dosyasındaki her host'u işle
for report_host in soup.find_all("ReportHost"):
    dns_name = report_host.get('name')
    ip_address = None
    
    for tag in report_host.find_all("tag"):
        if tag.get('name') == 'host-ip':
            ip_address = tag.text
    
    # Her host'un zafiyetlerini bul
    for report_item in report_host.find_all("ReportItem"):
        plugin_name = report_item.get('pluginName', 'N/A')
        synopsis = report_item.find('synopsis').text if report_item.find('synopsis') else 'N/A'
        description = report_item.find('description').text if report_item.find('description') else 'N/A'
        see_also = report_item.find('see_also').text if report_item.find('see_also') else 'N/A'
        solution = report_item.find('solution').text if report_item.find('solution') else 'N/A'
        risk_factor = report_item.find('risk_factor').text if report_item.find('risk_factor') else 'N/A'
        
        # Risk Factor "None" ise bu satırı atla
        if risk_factor == "None":
            continue
        
        # Port/Service/Protocol değerlerini al
        port = report_item.get('port', 'N/A')
        svc_name = report_item.get('svc_name', 'N/A')
        protocol = report_item.get('protocol', 'N/A')
        
        # Port 0 ise N/A olarak ayarla
        if port == '0':
            port = 'N/A'
        
        # Birleştir ve formata uygun hale getir
        port_service_protocol = f"{port}/{svc_name}/{protocol}"
        
        # CVSS değerini al
        cvss_vector = report_item.find('cvss_vector').text if report_item.find('cvss_vector') else 'N/A'
        
        # Verileri bir satır olarak kaydet
        data.append({
            'DNS Name': dns_name,
            'IP': ip_address,
            'Risk Factor': risk_factor,
            'Vulnerability': plugin_name,
            'Port/Service/Protocol': port_service_protocol,
            'CVSS': cvss_vector,
            'Synopsis': synopsis,
            'Description': description,
            'References': see_also,
            'Solution': solution
        })

# Verileri pandas DataFrame'e dönüştür
df = pd.DataFrame(data)

# Risk Factor'e göre sıralama yap
df['Risk Factor Order'] = df['Risk Factor'].map(risk_order)
df = df.sort_values(by='Risk Factor Order').drop(columns='Risk Factor Order')

# İstenen başlık sırasını koru
df = df[['DNS Name', 'IP', 'Risk Factor', 'Vulnerability', 'Port/Service/Protocol', 'CVSS', 'Synopsis', 'Description', 'References', 'Solution']]

# CSV olarak kaydet
csv_output = f'{output_filename}.csv'
df.to_csv(csv_output, index=False)

# XLSX olarak kaydet
xlsx_output = f'{output_filename}.xlsx'
df.to_excel(xlsx_output, index=False)

print(f"CSV kaydedildi: {csv_output}")
print(f"XLSX kaydedildi: {xlsx_output}")
