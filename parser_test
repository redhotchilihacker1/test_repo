import xml.etree.ElementTree as ET
import pandas as pd
from bs4 import BeautifulSoup
import sys

# CVSS v3 puanını hesaplamak için fonksiyon
def calculate_cvss_v3_score(cvss_vector):
    # CVSS v3.0 bileşenlerinin varsayılan değerleri
    metrics = {
        'AV': {'N': 0.85, 'A': 0.62, 'L': 0.55, 'P': 0.2},
        'AC': {'L': 0.77, 'H': 0.44},
        'PR': {'N': 0.85, 'L': 0.62, 'H': 0.27},
        'UI': {'N': 0.85, 'R': 0.62},
        'S': {'U': 1.0, 'C': 1.5},
        'C': {'N': 0.0, 'L': 0.22, 'H': 0.56},
        'I': {'N': 0.0, 'L': 0.22, 'H': 0.56},
        'A': {'N': 0.0, 'L': 0.22, 'H': 0.56}
    }
    
    # CVSS vektörünü kontrol et
    if not cvss_vector or not cvss_vector.startswith("CVSS:3.0"):
        return "N/A"  # Geçersiz vektör

    components = cvss_vector[8:].split('/')
    
    # Beklenen 8 bileşen olup olmadığını kontrol et
    if len(components) < 8:
        return "N/A"  # Eksik bileşenler varsa geçersiz vektör
    
    try:
        # Bileşenleri al
        av = components[0].split(':')[1]
        ac = components[1].split(':')[1]
        pr = components[2].split(':')[1]
        ui = components[3].split(':')[1]
        s = components[4].split(':')[1]
        c = components[5].split(':')[1]
        i = components[6].split(':')[1]
        a = components[7].split(':')[1]

        # Base Score hesapla
        impact = 1 - ((1 - metrics['C'][c]) * (1 - metrics['I'][i]) * (1 - metrics['A'][a]))
        if s == 'U':
            impact_score = 6.42 * impact
        else:
            impact_score = 7.52 * (impact - 0.029) - 3.25 * (impact - 0.02)**15

        exploitability_score = 8.22 * metrics['AV'][av] * metrics['AC'][ac] * metrics['PR'][pr] * metrics['UI'][ui]

        base_score = impact_score + exploitability_score
        if impact <= 0:
            base_score = 0
        else:
            if s == 'U':
                base_score = min(base_score, 10)
            else:
                base_score = min(base_score, 15)

        return round(base_score, 1)

    except KeyError as e:
        print(f"KeyError: {e} - Geçersiz CVSS bileşeni: {cvss_vector}")
        return "N/A"

# Kullanıcıdan dosya yolunu ve kaydedilecek dosya adını al
if len(sys.argv) != 3:
    print("Kullanım: python script.py <input.nessus> <output_filename>")
    sys.exit(1)

nessus_file = sys.argv[1]
output_filename = sys.argv[2]

# Nessus dosyasını yükle ve BeautifulSoup ile ayrıştır
with open(nessus_file, 'r', encoding='utf-8') as file:
    content = file.read()
    soup = BeautifulSoup(content, 'xml')  # XML olarak ayrıştır

# Verileri tutmak için listeler
data = []

# Risk Factor önceliklerini tanımla
risk_order = {
    "Critical": 1,
    "High": 2,
    "Medium": 3,
    "Low": 4,
    "None": 5  # "None" olanları en sona eklemek için
}

# Nessus dosyasındaki her host'u işle
for report_host in soup.find_all("ReportHost"):
    dns_name = report_host.get('name')
    ip_address = None
    
    for tag in report_host.find_all("tag"):
        if tag.get('name') == 'host-ip':
            ip_address = tag.text
    
    # Her host'un zafiyetlerini bul
    for report_item in report_host.find_all("ReportItem"):
        plugin_name = report_item.get('pluginName', 'N/A')
        synopsis = report_item.find('synopsis').text if report_item.find('synopsis') else 'N/A'
        description = report_item.find('description').text if report_item.find('description') else 'N/A'
        see_also = report_item.find('see_also').text if report_item.find('see_also') else 'N/A'
        solution = report_item.find('solution').text if report_item.find('solution') else 'N/A'
        risk_factor = report_item.find('risk_factor').text if report_item.find('risk_factor') else 'N/A'
        
        # Risk Factor "None" ise bu satırı atla
        if risk_factor == "None":
            continue
        
        # Port/Service/Protocol değerlerini al
        port = report_item.get('port', 'N/A')
        svc_name = report_item.get('svc_name', 'N/A')
        protocol = report_item.get('protocol', 'N/A')
        
        # Port 0 ise N/A olarak ayarla
        if port == '0':
            port = 'N/A'
        
        # Birleştir ve formata uygun hale getir
        port_service_protocol = f"{port}/{svc_name}/{protocol}"
        
        # CVSS v3 değerini al
        cvss3_vector = report_item.find('cvss3_vector').text if report_item.find('cvss3_vector') else 'N/A'
        
        # CVSS v3 puanını hesapla
        cvss_score = calculate_cvss_v3_score(cvss3_vector)
        
        # Verileri bir satır olarak kaydet
        data.append({
            'DNS Name': dns_name,
            'IP': ip_address,
            'Vulnerability': plugin_name,
            'Synopsis': synopsis,
            'Description': description,
            'References': see_also,
            'Solution': solution,
            'Risk Factor': risk_factor,
            'Port/Service/Protocol': port_service_protocol,
            'CVSS Vector': cvss3_vector,
            'CVSS Score': cvss_score
        })

# Verileri pandas DataFrame'e dönüştür
df = pd.DataFrame(data)

# Risk Factor'e göre sıralama yap
df['Risk Factor Order'] = df['Risk Factor'].map(risk_order)
df = df.sort_values(by='Risk Factor Order').drop(columns='Risk Factor Order')

# CSV olarak kaydet
csv_output = f'{output_filename}.csv'
df.to_csv(csv_output, index=False)

# XLSX olarak kaydet
xlsx_output = f'{output_filename}.xlsx'
df.to_excel(xlsx_output, index=False)

print(f"CSV kaydedildi: {csv_output}")
print(f"XLSX kaydedildi: {xlsx_output}")
